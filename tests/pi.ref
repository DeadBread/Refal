	entry go
	extrn repeat(multe)
	extrn add, sub, mul, div, dr
	extrn inc(p1), dec(m1), textToNumber(cvb), numberToText(cvd)

* pi/4 = 4*arctg(1/5) - arctg(1/239)
* arctg(x) = x - 1/x + 1/(3*x^3) - 1/(5*x^5) + ...

* 10^9 < 5^13 
* 10^1000 < (10^9)^112 < 5^(13*112) = 5^1456
* 10^6 < 239^3
* 10^1000 < (10^6)^167 < 239^(3*167) = 239^501

go = <resultAndPrecision<test /1456//501//1000/>>

resultAndPrecision
	e1 = 'Precision: '<numberToText<commonPrefix(<truepi>)e1>>'\n'e1

test s(N)5 s(N)9 s(N)c = <numberToText<pi s5s9<textToNumber'4'<repeat sc'0'>>>>

* calculate pi
pi s(N)5 s(N)9 v(N)k = <calc(<mul(/4/)vk>)(vk)<sum s5/5/><sum s9/239/>>

calc (v(N)1) (v(N)2) (v(N)a) (v(N)b) (v(N)c) (v(N)d) =+
	<div(<sub(<mul(v1)<mul(va)vd>>)<mul(v2)<mul(vc)vb>>>)<mul(vb)vd>>

correct
	s(F)o (v(N)n) ((v(N)x)v(N)d) si ss =+
		(kso(<mul(<mul(<inc si>)ss>)vn>)vx.)((<mul(<inc si>)vx>)<mul(ss)vd>)

addOrSub
	e1(/0/) = /add/
	e1(/1/) = /sub/

doSum
	s(N)k s(N)k s(N)s (v(N)n) (vd) = (vn) (<mul vd>)
	s(N)k s(N)i s(N)s (v(N)n) (vd) = <doSum sk<inc si>ss+
		<correct<addOrSub<dr(si)/2/>>(vn)(vd)<mul(/2/)si>ss>>

sum s(N)ns(N)x = <doSum sn/1/<mul(sx)sx>(/1/)((/1/)sx)>

* return number of top level matching terms from the begining
commonPrefix
	()e1 = /0/
	(e1) = /0/
	(w1e2)w1e3 = <inc<commonPrefix(e2)e3>>
	(w1e3)w2e4 = /0/

* first 1001 decimal digits of PI to check program result
truepi = '31415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989'
